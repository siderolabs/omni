suite: ETCD Key Secret Logic
templates:
  - secret-etcdkey.yaml

tests:
  # ========================================
  # Secret Creation Tests
  # ========================================
  - it: Should create secret when existingSecret is not set
    template: secret-etcdkey.yaml
    set:
      etcdEncryptionKey:
        existingSecret: ""
        omniAsc: |-
          -----BEGIN AGE ENCRYPTED FILE-----
          ExampleKeyContent...
          -----END AGE ENCRYPTED FILE-----
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-omni-etcd-key

  - it: Should not create secret when existingSecret is set
    template: secret-etcdkey.yaml
    set:
      etcdEncryptionKey:
        existingSecret: my-pre-existing-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: Should have correct secret type
    template: secret-etcdkey.yaml
    set:
      etcdEncryptionKey:
        existingSecret: ""
        omniAsc: "test-key"
    asserts:
      - equal:
          path: type
          value: Opaque

  - it: Should store key in stringData with correct key name
    template: secret-etcdkey.yaml
    set:
      etcdEncryptionKey:
        existingSecret: ""
        omniAsc: |-
          -----BEGIN PGP PRIVATE KEY BLOCK-----
          ExampleKeyContent123456789...
          -----END PGP PRIVATE KEY BLOCK-----
    asserts:
      - isNotNull:
          path: stringData["omni.asc"]
      - matchRegex:
          path: stringData["omni.asc"]
          pattern: "-----BEGIN PGP PRIVATE KEY BLOCK-----"

  - it: Should include standard Helm labels
    template: secret-etcdkey.yaml
    set:
      etcdEncryptionKey:
        existingSecret: ""
        omniAsc: "test-key"
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: omni
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - isNotNull:
          path: metadata.labels["helm.sh/chart"]

  - it: Should be created in correct namespace
    template: secret-etcdkey.yaml
    release:
      namespace: custom-namespace
    set:
      etcdEncryptionKey:
        existingSecret: ""
        omniAsc: "test-key"
    asserts:
      - equal:
          path: metadata.namespace
          value: custom-namespace

  # ========================================
  # Key Content Tests
  # ========================================
  - it: Should handle multiline key content correctly
    template: secret-etcdkey.yaml
    set:
      etcdEncryptionKey:
        existingSecret: ""
        omniAsc: |-
          -----BEGIN PGP PRIVATE KEY BLOCK-----
          Line1Content
          Line2Content
          Line3Content
          -----END PGP PRIVATE KEY BLOCK-----
    asserts:
      - matchRegex:
          path: stringData["omni.asc"]
          pattern: "Line1Content"
      - matchRegex:
          path: stringData["omni.asc"]
          pattern: "Line2Content"
      - matchRegex:
          path: stringData["omni.asc"]
          pattern: "Line3Content"