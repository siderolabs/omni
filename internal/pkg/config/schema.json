{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Params",
  "type": "object",
  "required": [
    "account",
    "services",
    "auth",
    "logs",
    "storage",
    "etcdBackup",
    "registries",
    "debug",
    "features"
  ],
  "goJSONSchema": {
    "imports": [
      "time"
    ]
  },
  "properties": {
    "account": {
      "$ref": "#/definitions/Account"
    },
    "services": {
      "$ref": "#/definitions/Services"
    },
    "auth": {
      "$ref": "#/definitions/Auth"
    },
    "logs": {
      "$ref": "#/definitions/Logs"
    },
    "storage": {
      "$ref": "#/definitions/Storage"
    },
    "etcdBackup": {
      "$ref": "#/definitions/EtcdBackup"
    },
    "registries": {
      "$ref": "#/definitions/Registries"
    },
    "debug": {
      "$ref": "#/definitions/Debug"
    },
    "features": {
      "$ref": "#/definitions/Features"
    }
  },
  "definitions": {
    "Account": {
      "type": "object",
      "required": [
        "userPilot",
        "id",
        "name"
      ],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1,
          "description": "Stable identifier of the instance.",
          "goJSONSchema": {
            "type": "*string"
          }
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "User-facing name of the instance.",
          "goJSONSchema": {
            "type": "*string"
          }
        },
        "userPilot": {
          "$ref": "#/definitions/UserPilot"
        }
      }
    },
    "UserPilot": {
      "type": "object",
      "properties": {
        "appToken": {
          "type": "string"
        }
      }
    },
    "Registries": {
      "type": "object",
      "required": [
        "talos",
        "kubernetes",
        "imageFactoryBaseURL"
      ],
      "properties": {
        "talos": {
          "type": "string",
          "minLength": 1,
          "goJSONSchema": {
            "type": "*string"
          }
        },
        "kubernetes": {
          "type": "string",
          "minLength": 1,
          "goJSONSchema": {
            "type": "*string"
          }
        },
        "imageFactoryBaseURL": {
          "type": "string",
          "minLength": 1,
          "goJSONSchema": {
            "type": "*string"
          }
        },
        "imageFactoryPXEBaseURL": {
          "type": "string"
        },
        "mirrors": {
          "type": "array",
          "goJSONSchema": {
            "extraTags": {
              "merge": "replace"
            }
          },
          "items": {
            "type": "string"
          }
        }
      }
    },
    "Services": {
      "type": "object",
      "required": [
        "api",
        "devServerProxy",
        "metrics",
        "kubernetesProxy",
        "siderolink",
        "machineAPI",
        "localResourceService",
        "embeddedDiscoveryService",
        "loadBalancer",
        "workloadProxy"
      ],
      "properties": {
        "api": {
          "$ref": "#/definitions/Service"
        },
        "devServerProxy": {
          "$ref": "#/definitions/DevServerProxyService"
        },
        "metrics": {
          "$ref": "#/definitions/Service"
        },
        "kubernetesProxy": {
          "$ref": "#/definitions/KubernetesProxyService"
        },
        "siderolink": {
          "$ref": "#/definitions/SiderolinkService"
        },
        "machineAPI": {
          "$ref": "#/definitions/Service",
          "description": "Config for MachineAPI"
        },
        "localResourceService": {
          "$ref": "#/definitions/LocalResourceService"
        },
        "embeddedDiscoveryService": {
          "$ref": "#/definitions/EmbeddedDiscoveryService"
        },
        "loadBalancer": {
          "$ref": "#/definitions/LoadBalancerService"
        },
        "workloadProxy": {
          "$ref": "#/definitions/WorkloadProxy"
        }
      }
    },
    "Service": {
      "type": "object",
      "properties": {
        "endpoint": {
          "type": "string"
        },
        "advertisedURL": {
          "type": "string"
        },
        "certFile": {
          "type": "string"
        },
        "keyFile": {
          "type": "string"
        }
      }
    },
    "DevServerProxyService": {
      "type": "object",
      "description": "Embeds Service",
      "properties": {
        "endpoint": {
          "type": "string"
        },
        "advertisedURL": {
          "type": "string"
        },
        "certFile": {
          "type": "string"
        },
        "keyFile": {
          "type": "string"
        },
        "proxyTo": {
          "type": "string"
        }
      }
    },
    "KubernetesProxyService": {
      "type": "object",
      "properties": {
        "endpoint": {
          "type": "string"
        },
        "advertisedURL": {
          "type": "string"
        },
        "certFile": {
          "type": "string"
        },
        "keyFile": {
          "type": "string"
        }
      }
    },
    "SiderolinkService": {
      "type": "object",
      "required": [
        "wireGuard"
      ],
      "properties": {
        "wireGuard": {
          "$ref": "#/definitions/SiderolinkWireGuard"
        },
        "joinTokensMode": {
          "type": "string",
          "enum": [
            "strict",
            "legacyAllowed",
            "legacy"
          ]
        },
        "disableLastEndpoint": {
          "type": "boolean"
        },
        "useGRPCTunnel": {
          "type": "boolean"
        },
        "eventSinkPort": {
          "type": "integer"
        },
        "logServerPort": {
          "type": "integer"
        }
      }
    },
    "SiderolinkWireGuard": {
      "type": "object",
      "properties": {
        "endpoint": {
          "type": "string"
        },
        "advertisedEndpoint": {
          "type": "string"
        }
      }
    },
    "LocalResourceService": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "port": {
          "type": "integer"
        }
      }
    },
    "EmbeddedDiscoveryService": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "port": {
          "type": "integer"
        },
        "snapshotsEnabled": {
          "type": "boolean"
        },
        "snapshotsPath": {
          "type": "string",
          "deprecated": true
        },
        "snapshotsInterval": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        },
        "logLevel": {
          "type": "string"
        },
        "sqliteTimeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        }
      }
    },
    "LoadBalancerService": {
      "type": "object",
      "properties": {
        "minPort": {
          "type": "integer"
        },
        "maxPort": {
          "type": "integer"
        },
        "dialTimeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        },
        "keepAlivePeriod": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        },
        "tcpUserTimeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        },
        "healthCheckInterval": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        },
        "healthCheckTimeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        }
      }
    },
    "WorkloadProxy": {
      "type": "object",
      "properties": {
        "subdomain": {
          "type": "string"
        },
        "enabled": {
          "type": "boolean"
        },
        "stopLBsAfter": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        }
      }
    },
    "Auth": {
      "type": "object",
      "required": [
        "auth0",
        "webauthn",
        "saml",
        "oidc",
        "keyPruner",
        "initialServiceAccount"
      ],
      "if": {
        "title": "Check Auth0",
        "properties": {
          "auth0": {
            "properties": {
              "enabled": {
                "const": true
              }
            },
            "required": [
              "enabled"
            ]
          }
        }
      },
      "then": {
        "properties": {
          "webauthn": {
            "properties": {
              "enabled": {
                "not": {
                  "const": true
                }
              }
            }
          },
          "saml": {
            "properties": {
              "enabled": {
                "not": {
                  "const": true
                }
              }
            }
          },
          "oidc": {
            "properties": {
              "enabled": {
                "not": {
                  "const": true
                }
              }
            }
          }
        }
      },
      "else": {
        "if": {
          "title": "Check WebAuthn",
          "properties": {
            "webauthn": {
              "properties": {
                "enabled": {
                  "const": true
                }
              },
              "required": [
                "enabled"
              ]
            }
          }
        },
        "then": {
          "properties": {
            "saml": {
              "properties": {
                "enabled": {
                  "not": {
                    "const": true
                  }
                }
              }
            },
            "oidc": {
              "properties": {
                "enabled": {
                  "not": {
                    "const": true
                  }
                }
              }
            }
          }
        },
        "else": {
          "if": {
            "title": "Check SAML",
            "properties": {
              "saml": {
                "properties": {
                  "enabled": {
                    "const": true
                  }
                },
                "required": [
                  "enabled"
                ]
              }
            }
          },
          "then": {
            "properties": {
              "oidc": {
                "properties": {
                  "enabled": {
                    "not": {
                      "const": true
                    }
                  }
                }
              }
            }
          }
        }
      },
      "properties": {
        "auth0": {
          "$ref": "#/definitions/Auth0"
        },
        "webauthn": {
          "$ref": "#/definitions/WebAuthn"
        },
        "saml": {
          "$ref": "#/definitions/SAML"
        },
        "oidc": {
          "$ref": "#/definitions/OIDC"
        },
        "initialUsers": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "keyPruner": {
          "$ref": "#/definitions/KeyPrunerConfig"
        },
        "suspended": {
          "type": "boolean"
        },
        "initialServiceAccount": {
          "$ref": "#/definitions/InitialServiceAccount"
        }
      }
    },
    "Auth0": {
      "type": "object",
      "properties": {
        "initialUsers": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "deprecated": true
        },
        "domain": {
          "type": "string"
        },
        "clientID": {
          "type": "string"
        },
        "useFormData": {
          "type": "boolean"
        },
        "enabled": {
          "type": "boolean"
        }
      }
    },
    "WebAuthn": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "required": {
          "type": "boolean"
        }
      }
    },
    "OIDC": {
      "type": "object",
      "properties": {
        "providerURL": {
          "type": "string"
        },
        "clientID": {
          "type": "string"
        },
        "clientSecret": {
          "type": "string"
        },
        "logoutURL": {
          "type": "string"
        },
        "scopes": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "enabled": {
          "type": "boolean"
        },
        "allowUnverifiedEmail": {
          "type": "boolean"
        }
      }
    },
    "SAML": {
      "type": "object",
      "required": [
        "labelRules",
        "attributeRules"
      ],
      "not": {
        "required": [
          "url",
          "metadata"
        ]
      },
      "properties": {
        "labelRules": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "attributeRules": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "url": {
          "type": "string"
        },
        "metadata": {
          "type": "string"
        },
        "nameIDFormat": {
          "type": "string"
        },
        "enabled": {
          "type": "boolean"
        }
      }
    },
    "KeyPrunerConfig": {
      "type": "object",
      "properties": {
        "interval": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        }
      }
    },
    "InitialServiceAccount": {
      "type": "object",
      "properties": {
        "role": {
          "type": "string"
        },
        "keyPath": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "lifetime": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        },
        "enabled": {
          "type": "boolean"
        }
      }
    },
    "Logs": {
      "type": "object",
      "required": [
        "machine",
        "audit",
        "resourceLogger",
        "stripe"
      ],
      "properties": {
        "machine": {
          "$ref": "#/definitions/LogsMachine"
        },
        "audit": {
          "$ref": "#/definitions/LogsAudit"
        },
        "resourceLogger": {
          "$ref": "#/definitions/ResourceLoggerConfig"
        },
        "stripe": {
          "$ref": "#/definitions/LogsStripe"
        }
      }
    },
    "LogsMachine": {
      "type": "object",
      "required": [
        "storage"
      ],
      "properties": {
        "storage": {
          "$ref": "#/definitions/LogsMachineStorage"
        },
        "bufferInitialCapacity": {
          "type": "integer",
          "deprecated": true
        },
        "bufferMaxCapacity": {
          "type": "integer",
          "deprecated": true
        },
        "bufferSafetyGap": {
          "type": "integer",
          "deprecated": true
        }
      }
    },
    "LogsMachineStorage": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "deprecated": true
        },
        "path": {
          "type": "string",
          "deprecated": true
        },
        "flushPeriod": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          },
          "deprecated": true
        },
        "flushJitter": {
          "type": "number",
          "deprecated": true
        },
        "numCompressedChunks": {
          "type": "integer",
          "deprecated": true
        },
        "sqliteTimeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        },
        "cleanupInterval": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        },
        "cleanupOlderThan": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        },
        "maxLinesPerMachine": {
          "type": "integer"
        },
        "cleanupProbability": {
          "type": "number"
        }
      }
    },
    "LogsAudit": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "path": {
          "type": "string",
          "deprecated": true
        },
        "sqliteTimeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        }
      }
    },
    "ResourceLoggerConfig": {
      "type": "object",
      "properties": {
        "logLevel": {
          "type": "string"
        },
        "types": {
          "type": "array",
          "goJSONSchema": {
            "extraTags": {
              "merge": "replace"
            }
          },
          "items": {
            "type": "string"
          }
        }
      }
    },
    "LogsStripe": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "minCommit": {
          "type": "integer",
          "minimum": 0,
          "goJSONSchema": {
            "type": "uint32"
          }
        }
      }
    },
    "Storage": {
      "type": "object",
      "required": [
        "default",
        "vault",
        "secondary",
        "sqlite"
      ],
      "properties": {
        "default": {
          "$ref": "#/definitions/StorageDefault"
        },
        "vault": {
          "$ref": "#/definitions/Vault"
        },
        "secondary": {
          "$ref": "#/definitions/BoltDB",
          "deprecated": true
        },
        "sqlite": {
          "$ref": "#/definitions/SQLite"
        }
      }
    },
    "Vault": {
      "type": "object",
      "properties": {
        "url": {
          "type": "string"
        },
        "token": {
          "type": "string"
        }
      }
    },
    "StorageDefault": {
      "type": "object",
      "required": [
        "boltdb",
        "etcd"
      ],
      "properties": {
        "kind": {
          "type": "string",
          "enum": [
            "etcd",
            "boltdb"
          ]
        },
        "boltdb": {
          "$ref": "#/definitions/BoltDB"
        },
        "etcd": {
          "$ref": "#/definitions/EtcdParams"
        }
      }
    },
    "BoltDB": {
      "type": "object",
      "properties": {
        "path": {
          "type": "string"
        }
      }
    },
    "SQLite": {
      "type": "object",
      "required": [
        "path"
      ],
      "properties": {
        "path": {
          "type": "string",
          "minLength": 1,
          "goJSONSchema": {
            "type": "*string"
          }
        },
        "experimentalBaseParams": {
          "type": "string"
        },
        "extraParams": {
          "type": "string"
        }
      }
    },
    "EtcdParams": {
      "type": "object",
      "required": [
        "privateKeySource"
      ],
      "properties": {
        "endpoints": {
          "type": "array",
          "goJSONSchema": {
            "extraTags": {
              "merge": "replace"
            }
          },
          "items": {
            "type": "string"
          }
        },
        "dialKeepAliveTime": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        },
        "dialKeepAliveTimeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        },
        "caFile": {
          "type": "string"
        },
        "certFile": {
          "type": "string"
        },
        "keyFile": {
          "type": "string"
        },
        "embedded": {
          "type": "boolean"
        },
        "embeddedDBPath": {
          "type": "string"
        },
        "embeddedUnsafeFsync": {
          "type": "boolean"
        },
        "runElections": {
          "type": "boolean"
        },
        "privateKeySource": {
          "type": "string",
          "minLength": 1,
          "goJSONSchema": {
            "type": "*string"
          }
        },
        "publicKeyFiles": {
          "type": "array",
          "goJSONSchema": {
            "extraTags": {
              "merge": "replace"
            }
          },
          "items": {
            "type": "string"
          }
        }
      }
    },
    "EtcdBackup": {
      "type": "object",
      "if": {
        "properties": {
          "s3Enabled": {
            "const": true
          }
        },
        "required": [
          "s3Enabled"
        ]
      },
      "then": {
        "not": {
          "required": [
            "localPath"
          ]
        }
      },
      "properties": {
        "localPath": {
          "type": "string"
        },
        "s3Enabled": {
          "type": "boolean"
        },
        "tickInterval": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        },
        "minInterval": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        },
        "maxInterval": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        },
        "uploadLimitMbps": {
          "type": "integer",
          "minimum": 0,
          "goJSONSchema": {
            "type": "uint64"
          }
        },
        "downloadLimitMbps": {
          "type": "integer",
          "minimum": 0,
          "goJSONSchema": {
            "type": "uint64"
          }
        },
        "jitter": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "goJSONSchema": {
            "type": "time.Duration"
          }
        }
      }
    },
    "Debug": {
      "type": "object",
      "required": [
        "server",
        "pprof"
      ],
      "properties": {
        "server": {
          "$ref": "#/definitions/DebugServer"
        },
        "pprof": {
          "$ref": "#/definitions/DebugPprof"
        }
      }
    },
    "DebugServer": {
      "type": "object",
      "properties": {
        "endpoint": {
          "type": "string"
        }
      }
    },
    "DebugPprof": {
      "type": "object",
      "properties": {
        "endpoint": {
          "type": "string"
        }
      }
    },
    "Features": {
      "type": "object",
      "properties": {
        "enableTalosPreReleaseVersions": {
          "type": "boolean"
        },
        "enableBreakGlassConfigs": {
          "type": "boolean"
        },
        "enableConfigDataCompression": {
          "type": "boolean"
        },
        "enableClusterImport": {
          "type": "boolean"
        },
        "disableControllerRuntimeCache": {
          "type": "boolean"
        }
      }
    }
  }
}
